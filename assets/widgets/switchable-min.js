/*! caja-kissy  */
KISSY.add("init-countdown-widgets",function(n){function t(t,e){var r=this;cfg={timeBegin:0,collateurl:"",collateval:0},r.timeStart=new Date,r.config=n.merge(cfg,e||{}),r._countTime(t)}function e(t,r,i){var o={d:".ks-d",h:".ks-h",m:".ks-m",s:".ks-s",i:".ks-i"},a={interval:1e3,timeUnitCls:o,minDigit:2,timeRunCls:".ks-countdown-run",timeEndCls:".ks-countdown-end"},s=n.merge(a,i);s.run&&!n.isFunction(s.run)&&delete s.run,s.end&&!n.isFunction(s.end)&&delete s.end,s.interval=parseInt(s.interval),(isNaN(s.interval)||200>s.interval)&&(s.interval=200),e.superclass.constructor.call(this,r,s),this.counter(t)}function r(t,e){var r=function(t){n.isDate(t)||(t=new Date),n.isFunction(e)&&e(t)};n.io({url:t,type:"HEAD",success:function(n,t,e){r(new Date(e.getResponseHeader("date")))},error:function(){r(new Date)},cache:!1})}function r(t,e){function r(n,t){1e3>n?e(t):3>o?i():e(new Date(t.setMilliseconds(t.getMilliseconds()+n/2)))}function i(){var e=new Date;o++,n.io({url:t,type:"HEAD",success:function(n,t,i){r(new Date-e,new Date(i.getResponseHeader("date")))},error:function(){r()},cache:!1})}var o=0;i()}function i(t,e,i){t="."+(t||"J_TWidget");var a=function(r){n.query(t,e).each(function(t){var e=o.attr(t,"data-widget-type"),i=o.attr(t,"data-widget-config");"Countdown"===e&&(i=n.isNull(i)?{}:JSON.parse(i.replace(/'/g,'"')),r&&n.isDate(r)&&(i.timeBegin=r),new n.Countdown(t,i.endTime,i))})};i?r(i,a):a()}var o=n.DOM,a={d:864e5,h:36e5,m:6e4,s:1e3,i:1},s=["d","h","m","s","i"];return t.prototype={_countTime:function(t){var e=this,r=e.config,i=r.timeBegin,o=0;if(/^(\d{4})\-(\d{1,2})\-(\d{1,2})(\s+)(\d{1,2}):(\d{1,2}):(\d{1,2})$/gi.test(t.replace(/\./g,"-"))){var a=t.match(/\d+/g);t=new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5])}else/^\d+&/.test(t)&&(t=parseInt(t));o=n.isNull(i)||isNaN(i)||0>=i?n.isDate(t)?t-new Date:parseInt(t):typeof i==typeof t?t-i:0,(!n.isNumber(o)||0>o)&&(o=0),e.timeRemain=o},getRemain:function(){var n=parseInt(this.timeRemain-(new Date-this.timeStart));return isNaN(n)||0>=n?0:n},format:function(t){var e=Array.prototype.slice.call(arguments,1),r=[];return n.each(e,function(n){if(a[n]){var e=Math.floor(t/a[n]);t-=e*a[n],r.push(e)}}),r},fetch:function(n,t,e){var r=this,i=setInterval(function(){var n=r.getRemain();n>0?t&&t.call(r,n):(t&&t.call(r,0),e&&e.call(r),clearInterval(i))},n)}},n.extend(e,t,{counter:function(t){var e=this,r=e.config,i=function(t){var i=[t].concat(d),o=e.format.apply(this,i);n.each(l,function(n,t){n.text(o[t])}),r.run&&r.run.call(e,i,o)},o=function(){u.hide(),c.show(),r.end&&r.end.call(e)},a=r.timeUnitCls,t=n.one(t),u=t.all(r.timeRunCls),c=t.all(r.timeEndCls),l=[],d=[];n.each(s,function(n){a[n]&&t.one(a[n])&&(l.push(t.one(a[n])),d.push(n))}),u.show(),c.hide(),e.fetch(r.interval,i,o)}}),e.autoRender=i,e.Core=t,e.getServerTime=r,n.Countdown=e,e}),KISSY.use("switchable, init-countdown-widgets",function(n,t,e){function r(r,i){function o(){n.later(function(){if(0!==u.length){try{a(u.shift())}catch(t){n.log("\u521d\u59cb\u5316\u7ec4\u4ef6\u51fa\u9519")}o()}},0)}function a(r){var i,o=r.getAttribute("data-widget-type");if(o)try{switch(i=r.getAttribute("data-widget-config"),i&&(i=i.replace(/'/g,'"')),i=n.JSON.parse(i),!0){case s.switchable.indexOf(o)>-1:new t(r,i);break;case s.countdown.indexOf(o)>-1:new e(r,i.endTime,i);break;default:n.log("\u5728kissy\u5e93\u4e2d\u6ca1\u6709\u67e5\u627e\u5230\u4f60\u60f3\u8981\u521d\u59cb\u5316\u7684\u7ec4\u4ef6")}}catch(a){n.log("widget "+a,"warn")}}r="."+(r||"KS_Widget");var s={switchable:"Tabs Slide Carousel Accordion",overlay:"Popup",countdown:"Countdown"},u=n.query(r,i);o()}var i=n.DOM,o="J_TScriptedModule";KISSY.each(i.query("."+o),function(n){r("J_TWidget",n)})});